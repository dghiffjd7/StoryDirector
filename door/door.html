<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MiPhone Door</title>
  </head>
  <body>
    <div id="MiPhone-door-root" style="display: none">MiPhone</div>
    <div data-door-ui></div>
    <script>
      (function () {
        const mount = document.querySelector('[data-door-ui]');
        if (!mount) return;
        const root = mount.attachShadow({ mode: 'open' });
        root.innerHTML =
          '<style>@import url("https://dghiffjd7.github.io/StoryDirector/door/door.css");</style><div class="fs"><div class="phone-wrap"><div class="phone"><div class="notch"></div><div class="screen"><div class="portal" aria-hidden="true"><div id="portal-center-image" class="portal-center-image" style="display: none;"></div><div id="portal-placeholder" class="portal-placeholder">ğŸ“·</div><div class="ring r1"></div><div class="ring r2"></div><div class="ring r3"></div><div class="image-controls"><button id="prev-image" class="image-control-btn" title="ä¸Šä¸€å¼ å›¾ç‰‡">â€¹</button><button id="next-image" class="image-control-btn" title="ä¸‹ä¸€å¼ å›¾ç‰‡">â€º</button><button id="random-image" class="image-control-btn" title="éšæœºå›¾ç‰‡">ğŸ²</button></div></div><div class="hud"><div class="topbar"><div class="title">ç©ºé—´é—¨ Â· æ§åˆ¶é¢æ¿</div><div class="spacer"></div><div class="settings-wrapper"><button id="btn-settings" class="icon-btn" title="è®¾ç½®">âš™</button><div id="settings-dropdown" class="dropdown-menu" style="display: none;"><div class="dropdown-item" id="dropdown-image-manager">ğŸ“· å›¾ç‰‡ç®¡ç†</div><div class="dropdown-item" id="dropdown-fullscreen">â¤¢ å…¨å±</div></div></div><div class="pts" id="ui-pts">å‰©ä½™ç‚¹æ•°ï¼š--</div></div><div class="cards"><div class="card" id="card-attrs"><div class="row"><div class="k">è·ç¦»(m)</div><div class="val" id="v-range">--</div><div class="btns"><button data-k="range_m" data-d="+1">+1</button><button data-k="range_m" data-d="-1">-1</button></div></div><div class="row"><div class="k">å¼€å£(cm)</div><div class="val" id="v-aperture">--</div><div class="btns"><button data-k="aperture_cm" data-d="+2">+2</button><button data-k="aperture_cm" data-d="-2">-2</button></div></div><div class="row"><div class="k">æŒç»­(s)</div><div class="val" id="v-duration">--</div><div class="btns"><button data-k="duration_s" data-d="+1">+1</button><button data-k="duration_s" data-d="-1">-1</button></div></div><div class="row"><div class="k">å†·å´(s)</div><div class="val" id="v-cd">--</div><div class="btns"><button data-k="cooldown_s" data-d="-2">-2</button><button data-k="cooldown_s" data-d="+2">+2</button></div></div><div class="row"><div class="k">ç¨³å®šç­‰çº§</div><div class="val" id="v-stab">--</div><div class="btns"><button data-k="stability" data-d="+1">+1</button><button data-k="stability" data-d="-1">-1</button></div></div></div></div><div class="foot"><div class="bar"><button id="btn-copy" class="ghost">å¤åˆ¶æç¤ºç‰‡æ®µ</button><button id="btn-refresh" class="ghost">åˆ·æ–°æ•°å€¼</button></div><div class="frag" id="frag">æç¤ºç‰‡æ®µå°†æ˜¾ç¤ºåœ¨æ­¤å¤„â€¦</div><div class="warn" id="msg"></div></div></div><div id="image-manager-modal" class="modal" style="display: none;"><div class="modal-content"><div class="modal-header"><div class="modal-title">ğŸ“· å›¾ç‰‡ç®¡ç†å™¨</div><button id="close-image-manager" class="modal-close">Ã—</button></div><div class="modal-body"><div class="slideshow-settings-section"><div class="section-title">ğŸ¬ å¹»ç¯ç‰‡è®¾ç½®</div><div class="settings-row"><label class="settings-label"><input type="checkbox" id="slideshow-enabled" checked> å¯ç”¨å¹»ç¯ç‰‡åŠŸèƒ½</label></div><div class="settings-row"><label class="settings-label">åˆ‡æ¢é—´éš”ï¼š<select id="slideshow-interval"><option value="1000">1ç§’</option><option value="2000">2ç§’</option><option value="3000">3ç§’</option><option value="5000" selected>5ç§’</option><option value="10000">10ç§’</option><option value="30000">30ç§’</option><option value="60000">1åˆ†é’Ÿ</option></select></label></div><div class="settings-help">ğŸ’¡ åŒ¹é…åˆ°å¤šå¼ å›¾ç‰‡æ—¶è‡ªåŠ¨è½®æ’­å±•ç¤º<br>ğŸšª è‡ªåŠ¨ç›‘å¬æ¥¼å±‚ä¸­çš„&lt;Door&gt;æ ‡ç­¾</div></div><div class="image-upload-section"><div class="upload-tabs"><button class="tab-btn active" data-tab="url">ğŸ”— URLé“¾æ¥</button><button class="tab-btn" data-tab="upload">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button></div><div class="tab-content" id="tab-url"><input type="text" id="image-url-input" placeholder="è¯·è¾“å…¥å›¾ç‰‡URLæˆ–base64æ•°æ®..." class="url-input"><div class="category-section"><input type="text" id="url-category-input" placeholder="å›¾ç‰‡åˆ†ç±»ï¼ˆå¦‚ï¼šè‡ªç„¶ã€å»ºç­‘ã€äººç‰©...ï¼‰" class="category-input"><input type="text" id="url-keywords-input" placeholder="å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šé˜³å…‰,æ²™æ»©,æµ·æµªï¼‰" class="keywords-input"></div><button id="add-image-url" class="btn-primary">æ·»åŠ å›¾ç‰‡</button></div><div class="tab-content" id="tab-upload" style="display: none;"><input type="file" id="image-file-input" accept="image/*" class="file-input"><div class="category-section"><input type="text" id="file-category-input" placeholder="å›¾ç‰‡åˆ†ç±»ï¼ˆå¦‚ï¼šè‡ªç„¶ã€å»ºç­‘ã€äººç‰©...ï¼‰" class="category-input"><input type="text" id="file-keywords-input" placeholder="å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šé˜³å…‰,æ²™æ»©,æµ·æµªï¼‰" class="keywords-input"></div><button id="add-image-file" class="btn-primary">æ·»åŠ å›¾ç‰‡</button></div></div><div class="image-list-section"><div class="section-title">å·²ä¿å­˜çš„å›¾ç‰‡</div><div id="image-list" class="image-list"></div></div><div id="image-edit-modal" class="edit-modal" style="display: none;"><div class="edit-modal-content"><div class="edit-modal-header"><div class="edit-modal-title">ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯</div><button id="close-edit-modal" class="edit-modal-close">Ã—</button></div><div class="edit-modal-body"><input type="text" id="edit-category-input" placeholder="å›¾ç‰‡åˆ†ç±»" class="category-input"><input type="text" id="edit-keywords-input" placeholder="å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰" class="keywords-input"><div class="edit-modal-actions"><button id="save-image-edit" class="btn-primary">ä¿å­˜</button><button id="cancel-image-edit" class="btn-secondary">å–æ¶ˆ</button></div></div></div></div></div></div></div></div></div></div>';
        const $ = sel => root.querySelector(sel);
        const $$ = sel => Array.from(root.querySelectorAll(sel));
        const Mvu = typeof parent !== 'undefined' && parent && parent.Mvu ? parent.Mvu : null;
        const ui = {
          pts: $('#ui-pts'),
          msg: $('#msg'),
          frag: $('#frag'),
          vals: {
            range: $('#v-range'),
            aperture: $('#v-aperture'),
            duration: $('#v-duration'),
            cd: $('#v-cd'),
            stab: $('#v-stab'),
          },
        };
        const fsEl = root.querySelector('.fs');
        const n = x => (typeof x === 'number' ? x : Number(x) || 0);
        function boundsOf(key) {
          const map = {
            range_m: { min: 1, max: 100, step: 1 },
            aperture_cm: { min: 5, max: 200, step: 2 },
            duration_s: { min: 1, max: 120, step: 1 },
            cooldown_s: { min: 0, max: 300, step: 2 },
            stability: { min: 1, max: 10, step: 1 },
          };
          return map[key] || { min: -1e9, max: 1e9, step: 1 };
        }
        function render(data) {
          if (!Mvu || !data) return;
          const get = (p, cat = 'stat') => Mvu.getMvuVariable(data, p, { category: cat });
          ui.pts.textContent = `å‰©ä½™ç‚¹æ•°ï¼š${n(get('points.remaining'))}`;
          ui.vals.range.textContent = n(get('ability.spatial_gate.range_m'));
          ui.vals.aperture.textContent = n(get('ability.spatial_gate.aperture_cm'));
          ui.vals.duration.textContent = n(get('ability.spatial_gate.duration_s'));
          ui.vals.cd.textContent = n(get('ability.spatial_gate.cooldown_s'));
          ui.vals.stab.textContent = n(get('ability.spatial_gate.stability'));
          const frag = get('prompt.spatial_gate', 'display') || '';
          ui.frag.textContent = frag || 'ï¼ˆå°šæœªç”Ÿæˆæç¤ºç‰‡æ®µï¼‰';
        }
        async function updatePromptFragment(data) {
          const get = p => Mvu.getMvuVariable(data, p);
          const r = n(get('ability.spatial_gate.range_m'));
          const a = n(get('ability.spatial_gate.aperture_cm'));
          const d = n(get('ability.spatial_gate.duration_s'));
          const c = n(get('ability.spatial_gate.cooldown_s'));
          const s = n(get('ability.spatial_gate.stability'));
          const frag = `ç©ºé—´é—¨ | è·ç¦»â‰¤${r}mï¼Œå¼€å£â‰¤${a}cmï¼ŒæŒç»­â‰¤${d}sï¼Œå†·å´â‰¥${c}sï¼Œç¨³å®šLv${s}`;
          await Mvu.setMvuVariable(data, 'prompt.spatial_gate', frag, {
            reason: 'åˆ·æ–°èƒ½åŠ›æç¤ºç‰‡æ®µ',
            is_recursive: true,
          });
        }
        async function applyDelta(key, delta) {
          ui.msg.textContent = '';
          if (!Mvu) {
            ui.msg.textContent = 'Mvu API ä¸å¯ç”¨';
            return;
          }
          const data = Mvu.getCurrentMvuData();
          const left = n(Mvu.getMvuVariable(data, 'points.remaining'));
          const cur = n(Mvu.getMvuVariable(data, `ability.spatial_gate.${key}`));
          const b = boundsOf(key);
          let cost = 0;
          if (key === 'cooldown_s') cost = delta < 0 ? 1 : 0;
          else cost = delta > 0 ? 1 : 0;
          if (cost > 0 && left <= 0) {
            ui.msg.textContent = 'ç‚¹æ•°ä¸è¶³';
            return;
          }
          let nxt = Math.max(b.min, Math.min(b.max, cur + delta));
          if (nxt === cur) {
            ui.msg.textContent = 'å·²åˆ°è¾¾è¾¹ç•Œ';
            return;
          }
          await Mvu.setMvuVariable(data, `ability.spatial_gate.${key}`, nxt, {
            reason: `è°ƒå‚ ${key}: ${cur}->${nxt}`,
            is_recursive: true,
          });
          if (cost !== 0) {
            await Mvu.setMvuVariable(data, 'points.remaining', Math.max(0, left - cost), {
              reason: cost > 0 ? 'æ¶ˆè€—ç‚¹æ•°' : 'è¿”è¿˜ç‚¹æ•°',
              is_recursive: true,
            });
          }
          await updatePromptFragment(data);
          await Mvu.replaceCurrentMvuData(data);
          render(data);
          ui.msg.textContent = `å·²æ›´æ–° ${key}: ${cur} â†’ ${nxt}`;
        }
        let savedImages = [];
        let selectedImageIndex = -1;
        let slideshowSettings = {
          enabled: true,
          interval: 5000, // é»˜è®¤5ç§’åˆ‡æ¢
        };
        let slideshowTimer = null;
        let slideshowImages = [];
        function loadSlideshowSettings() {
          const enabledCheckbox = $('#slideshow-enabled');
          const intervalSelect = $('#slideshow-interval');

          if (enabledCheckbox) {
            enabledCheckbox.checked = slideshowSettings.enabled;
          }
          if (intervalSelect) {
            intervalSelect.value = slideshowSettings.interval.toString();
          }
        }
        function saveSlideshowSettings() {
          const enabledCheckbox = $('#slideshow-enabled');
          const intervalSelect = $('#slideshow-interval');

          if (enabledCheckbox) {
            slideshowSettings.enabled = enabledCheckbox.checked;
          }
          if (intervalSelect) {
            slideshowSettings.interval = parseInt(intervalSelect.value, 10) || 5000;
          }

          // å¦‚æœå½“å‰æ­£åœ¨æ’­æ”¾å¹»ç¯ç‰‡ï¼Œé‡æ–°å¯åŠ¨ä»¥åº”ç”¨æ–°è®¾ç½®
          if (slideshowTimer && slideshowImages.length > 0) {
            const currentImages = savedImages.filter((_, index) => slideshowImages.includes(index));
            const matchedImages = currentImages.map((imageData, idx) => ({
              index: slideshowImages[idx],
              imageData: imageData,
            }));
            startSlideshow(matchedImages);
          }
        }
        function showImageManager() {
          $('#image-manager-modal').style.display = 'flex';
          loadImageList();
          loadSlideshowSettings();
        }
        function hideImageManager() {
          $('#image-manager-modal').style.display = 'none';
        }
        function loadImageList() {
          const imageList = $('#image-list');
          imageList.innerHTML = '';

          if (savedImages.length === 0) {
            imageList.innerHTML =
              '<div style="color: rgba(234, 255, 255, 0.5); text-align: center; padding: 20px; font-size: 13px;">æš‚æ— å›¾ç‰‡</div>';
            return;
          }

          savedImages.forEach((imageData, index) => {
            const item = document.createElement('div');
            item.className = `image-item ${index === selectedImageIndex ? 'selected' : ''}`;

            const categoryText = imageData.category ? `ğŸ“‚ ${imageData.category}` : '';
            const keywordsText =
              imageData.keywords && imageData.keywords.length > 0 ? `ğŸ·ï¸ ${imageData.keywords.join(', ')}` : '';

            item.innerHTML = `
              <img src="${imageData.url}" alt="å›¾ç‰‡ ${index + 1}" />
              <div class="image-info">
                ${categoryText ? `<div class="image-category">${categoryText}</div>` : ''}
                ${keywordsText ? `<div class="image-keywords">${keywordsText}</div>` : ''}
              </div>
              <button class="edit-btn" data-index="${index}" title="ç¼–è¾‘">âœï¸</button>
              <button class="delete-btn" data-index="${index}" title="åˆ é™¤">Ã—</button>
            `;

            item.addEventListener('click', e => {
              if (e.target.classList.contains('delete-btn') || e.target.classList.contains('edit-btn')) return;
              selectImageManually(index);
            });

            const editBtn = item.querySelector('.edit-btn');
            editBtn.addEventListener('click', e => {
              e.stopPropagation();
              editImageInfo(index);
            });

            const deleteBtn = item.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', e => {
              e.stopPropagation();
              deleteImage(index);
            });

            imageList.appendChild(item);
          });
        }
        function selectImage(index) {
          selectedImageIndex = index;
          loadImageList();
          updatePortalImage();
          ui.msg.textContent = `å·²é€‰æ‹©å›¾ç‰‡ ${index + 1}`;
        }
        function selectImageManually(index) {
          // æ‰‹åŠ¨é€‰æ‹©å›¾ç‰‡æ—¶åœæ­¢å¹»ç¯ç‰‡
          stopSlideshow();
          selectImage(index);
        }
        function deleteImage(index) {
          // åˆ é™¤å›¾ç‰‡æ—¶åœæ­¢å¹»ç¯ç‰‡
          stopSlideshow();

          savedImages.splice(index, 1);
          if (selectedImageIndex === index) {
            selectedImageIndex = -1;
            updatePortalImage();
          } else if (selectedImageIndex > index) {
            selectedImageIndex--;
          }
          loadImageList();
          ui.msg.textContent = 'å›¾ç‰‡å·²åˆ é™¤';
        }
        let editingImageIndex = -1;
        function editImageInfo(index) {
          editingImageIndex = index;
          const imageData = savedImages[index];
          const editModal = $('#image-edit-modal');
          const categoryInput = $('#edit-category-input');
          const keywordsInput = $('#edit-keywords-input');

          categoryInput.value = imageData.category || '';
          keywordsInput.value = imageData.keywords ? imageData.keywords.join(', ') : '';

          editModal.style.display = 'flex';
        }
        function saveImageEdit() {
          if (editingImageIndex < 0 || editingImageIndex >= savedImages.length) return;

          const categoryInput = $('#edit-category-input');
          const keywordsInput = $('#edit-keywords-input');
          const category = categoryInput.value.trim();
          const keywordsText = keywordsInput.value.trim();

          const keywords = keywordsText
            ? keywordsText
                .split(',')
                .map(k => k.trim())
                .filter(k => k.length > 0)
            : [];

          savedImages[editingImageIndex].category = category;
          savedImages[editingImageIndex].keywords = keywords;
          savedImages[editingImageIndex].name = category || savedImages[editingImageIndex].name;

          $('#image-edit-modal').style.display = 'none';
          loadImageList();
          ui.msg.textContent = 'å›¾ç‰‡ä¿¡æ¯å·²æ›´æ–°';
          editingImageIndex = -1;
        }
        function cancelImageEdit() {
          $('#image-edit-modal').style.display = 'none';
          editingImageIndex = -1;
        }
        function extractDoorKeywords(text) {
          // æå–<Door>æ ‡ç­¾ä¸­çš„å…³é”®è¯
          const doorRegex = /<Door>(.*?)<\/Door>/gi;
          const keywords = [];
          let match;

          while ((match = doorRegex.exec(text)) !== null) {
            const keywordText = match[1].trim();
            if (keywordText) {
              // æ”¯æŒé€—å·åˆ†éš”çš„å¤šä¸ªå…³é”®è¯
              const splitKeywords = keywordText
                .split(',')
                .map(k => k.trim())
                .filter(k => k.length > 0);
              keywords.push(...splitKeywords);
            }
          }

          return keywords;
        }
        function matchImagesByDoorKeywords(text) {
          if (!text || savedImages.length === 0) return [];

          const doorKeywords = extractDoorKeywords(text);
          if (doorKeywords.length === 0) return [];

          const matches = [];

          savedImages.forEach((imageData, index) => {
            let score = 0;
            const matchedKeywords = [];

            // æ£€æŸ¥åˆ†ç±»åŒ¹é…
            if (imageData.category) {
              doorKeywords.forEach(keyword => {
                if (keyword.toLowerCase() === imageData.category.toLowerCase()) {
                  score += 3; // åˆ†ç±»åŒ¹é…æƒé‡æ›´é«˜
                  matchedKeywords.push(keyword);
                }
              });
            }

            // æ£€æŸ¥å…³é”®è¯åŒ¹é…
            if (imageData.keywords && imageData.keywords.length > 0) {
              imageData.keywords.forEach(imgKeyword => {
                doorKeywords.forEach(doorKeyword => {
                  if (doorKeyword.toLowerCase() === imgKeyword.toLowerCase()) {
                    score += 2;
                    matchedKeywords.push(doorKeyword);
                  }
                });
              });
            }

            if (score > 0) {
              matches.push({
                index: index,
                score: score,
                matchedKeywords: matchedKeywords,
                imageData: imageData,
              });
            }
          });

          // æŒ‰åŒ¹é…åˆ†æ•°æ’åºï¼Œåˆ†æ•°é«˜çš„åœ¨å‰
          matches.sort((a, b) => b.score - a.score);
          return matches;
        }
        // ä¿ç•™åŸå‡½æ•°ç”¨äºæµ‹è¯•åŠŸèƒ½
        function matchImagesByKeywords(text) {
          if (!text || savedImages.length === 0) return [];

          const textLower = text.toLowerCase();
          const matches = [];

          savedImages.forEach((imageData, index) => {
            let score = 0;
            const matchedKeywords = [];

            // æ£€æŸ¥åˆ†ç±»åŒ¹é…
            if (imageData.category && textLower.includes(imageData.category.toLowerCase())) {
              score += 2;
              matchedKeywords.push(imageData.category);
            }

            // æ£€æŸ¥å…³é”®è¯åŒ¹é…
            if (imageData.keywords && imageData.keywords.length > 0) {
              imageData.keywords.forEach(keyword => {
                if (textLower.includes(keyword.toLowerCase())) {
                  score += 1;
                  matchedKeywords.push(keyword);
                }
              });
            }

            if (score > 0) {
              matches.push({
                index: index,
                score: score,
                matchedKeywords: matchedKeywords,
                imageData: imageData,
              });
            }
          });

          // æŒ‰åŒ¹é…åˆ†æ•°æ’åºï¼Œåˆ†æ•°é«˜çš„åœ¨å‰
          matches.sort((a, b) => b.score - a.score);
          return matches;
        }
        function stopSlideshow() {
          if (slideshowTimer) {
            clearInterval(slideshowTimer);
            slideshowTimer = null;
          }
          slideshowImages = [];
        }
        function startSlideshow(matchedImages) {
          stopSlideshow();

          if (!slideshowSettings.enabled || matchedImages.length <= 1) {
            if (matchedImages.length > 0) {
              selectImage(matchedImages[0].index);
            }
            return;
          }

          slideshowImages = matchedImages.map(m => m.index);
          let currentSlideIndex = 0;

          // æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
          selectImage(slideshowImages[currentSlideIndex]);

          // å¯åŠ¨è‡ªåŠ¨åˆ‡æ¢
          slideshowTimer = setInterval(() => {
            currentSlideIndex = (currentSlideIndex + 1) % slideshowImages.length;
            selectImage(slideshowImages[currentSlideIndex]);
          }, slideshowSettings.interval);

          const totalImages = slideshowImages.length;
          const intervalSeconds = slideshowSettings.interval / 1000;
          ui.msg.textContent = `å¹»ç¯ç‰‡æ’­æ”¾ä¸­ï¼š${totalImages}å¼ å›¾ç‰‡ï¼Œ${intervalSeconds}ç§’åˆ‡æ¢`;
        }
        function autoSelectImageByDoorKeywords(text) {
          const matches = matchImagesByDoorKeywords(text);

          if (matches.length === 0) {
            ui.msg.textContent = 'æœªæ‰¾åˆ°åŒ¹é…<Door>æ ‡ç­¾çš„å›¾ç‰‡';
            return false;
          }

          // è·å–æœ€é«˜åˆ†æ•°çš„æ‰€æœ‰å›¾ç‰‡
          const topScore = matches[0].score;
          const topMatches = matches.filter(m => m.score === topScore);

          if (topMatches.length === 1) {
            // åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œç›´æ¥é€‰æ‹©
            selectImage(topMatches[0].index);
            const keywordsText = topMatches[0].matchedKeywords.join(', ');
            ui.msg.textContent = `åŒ¹é…å›¾ç‰‡ï¼Œå…³é”®è¯ï¼š${keywordsText}`;
          } else {
            // å¤šå¼ å›¾ç‰‡ï¼Œå¯åŠ¨å¹»ç¯ç‰‡
            const keywordsText = topMatches[0].matchedKeywords.join(', ');
            ui.msg.textContent = `æ‰¾åˆ°${topMatches.length}å¼ åŒ¹é…å›¾ç‰‡ï¼Œå…³é”®è¯ï¼š${keywordsText}`;
            startSlideshow(topMatches);
          }

          return true;
        }
        // ä¿ç•™åŸå‡½æ•°ç”¨äºæµ‹è¯•åŠŸèƒ½
        function autoSelectImageByKeywords(text) {
          const matches = matchImagesByKeywords(text);

          if (matches.length === 0) {
            ui.msg.textContent = 'æœªæ‰¾åˆ°åŒ¹é…å…³é”®è¯çš„å›¾ç‰‡';
            return false;
          }

          // å¦‚æœæœ‰å¤šä¸ªç›¸åŒåˆ†æ•°çš„å›¾ç‰‡ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
          const topScore = matches[0].score;
          const topMatches = matches.filter(m => m.score === topScore);
          const selectedMatch = topMatches[Math.floor(Math.random() * topMatches.length)];

          selectImage(selectedMatch.index);

          const keywordsText = selectedMatch.matchedKeywords.join(', ');
          ui.msg.textContent = `è‡ªåŠ¨é€‰æ‹©å›¾ç‰‡ï¼ŒåŒ¹é…å…³é”®è¯ï¼š${keywordsText}`;

          return true;
        }
        function processAIResponse(responseText) {
          // è¿™ä¸ªå‡½æ•°å¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨æ¥å¤„ç†AIå›å¤
          // ä½¿ç”¨Dooræ ‡ç­¾åŒ¹é…åŠŸèƒ½
          return autoSelectImageByDoorKeywords(responseText);
        }
        function updatePortalImage() {
          const portalImage = $('#portal-center-image');
          const portalPlaceholder = $('#portal-placeholder');

          if (selectedImageIndex >= 0 && selectedImageIndex < savedImages.length) {
            const imageUrl = savedImages[selectedImageIndex].url;
            portalImage.style.backgroundImage = `url("${imageUrl}")`;
            portalImage.style.display = 'block';
            portalPlaceholder.style.display = 'none';
          } else {
            portalImage.style.backgroundImage = '';
            portalImage.style.display = 'none';
            portalPlaceholder.style.display = 'flex';
          }
        }
        async function addImageFromUrl() {
          const urlInput = $('#image-url-input');
          const categoryInput = $('#url-category-input');
          const keywordsInput = $('#url-keywords-input');
          const url = urlInput.value.trim();
          const category = categoryInput.value.trim();
          const keywordsText = keywordsInput.value.trim();

          if (!url) {
            ui.msg.textContent = 'è¯·è¾“å…¥å›¾ç‰‡URL';
            return;
          }

          try {
            // éªŒè¯å›¾ç‰‡æ˜¯å¦å¯åŠ è½½
            const img = new Image();
            img.crossOrigin = 'anonymous';

            await new Promise((resolve, reject) => {
              img.onload = resolve;
              img.onerror = reject;
              img.src = url;
            });

            // å¤„ç†å…³é”®è¯
            const keywords = keywordsText
              ? keywordsText
                  .split(',')
                  .map(k => k.trim())
                  .filter(k => k.length > 0)
              : [];

            // æ·»åŠ åˆ°ä¿å­˜åˆ—è¡¨
            const imageData = {
              url: url,
              name: category || `å›¾ç‰‡_${Date.now()}`,
              type: url.startsWith('data:') ? 'base64' : 'url',
              category: category,
              keywords: keywords,
            };

            savedImages.push(imageData);
            const newIndex = savedImages.length - 1;
            selectImage(newIndex);
            urlInput.value = '';
            categoryInput.value = '';
            keywordsInput.value = '';
            loadImageList();
            ui.msg.textContent = 'å›¾ç‰‡æ·»åŠ å¹¶é€‰ä¸­æˆåŠŸ';
          } catch (error) {
            ui.msg.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®';
          }
        }
        async function addImageFromFile() {
          const fileInput = $('#image-file-input');
          const categoryInput = $('#file-category-input');
          const keywordsInput = $('#file-keywords-input');
          const file = fileInput.files[0];
          const category = categoryInput.value.trim();
          const keywordsText = keywordsInput.value.trim();

          if (!file) {
            ui.msg.textContent = 'è¯·é€‰æ‹©æ–‡ä»¶';
            return;
          }

          if (!file.type.startsWith('image/')) {
            ui.msg.textContent = 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶';
            return;
          }

          try {
            const reader = new FileReader();

            await new Promise((resolve, reject) => {
              reader.onload = resolve;
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });

            // å¤„ç†å…³é”®è¯
            const keywords = keywordsText
              ? keywordsText
                  .split(',')
                  .map(k => k.trim())
                  .filter(k => k.length > 0)
              : [];

            const base64Url = reader.result;
            const imageData = {
              url: base64Url,
              name: category || file.name,
              type: 'file',
              category: category,
              keywords: keywords,
            };

            savedImages.push(imageData);
            const newIndex = savedImages.length - 1;
            selectImage(newIndex);
            fileInput.value = '';
            categoryInput.value = '';
            keywordsInput.value = '';
            loadImageList();
            ui.msg.textContent = 'å›¾ç‰‡ä¸Šä¼ å¹¶é€‰ä¸­æˆåŠŸ';
          } catch (error) {
            ui.msg.textContent = 'æ–‡ä»¶è¯»å–å¤±è´¥';
          }
        }
        function bind() {
          // ç¡®ä¿åœ¨ç»‘å®šæ—¶é‡æ–°è·å–å…ƒç´ å¼•ç”¨
          const settingsBtn = $('#btn-settings');
          const settingsDropdown = $('#settings-dropdown');

          if (!settingsBtn) {
            console.error('Settings button not found!');
            return;
          }
          if (!settingsDropdown) {
            console.error('Settings dropdown not found!');
            return;
          }

          $$('#card-attrs button[data-k]').forEach(btn => {
            btn.addEventListener('click', () => {
              const key = btn.getAttribute('data-k');
              const delta = Number(btn.getAttribute('data-d')) || 0;
              applyDelta(key, delta);
            });
          });
          $('#btn-refresh').addEventListener('click', () => {
            if (!Mvu) {
              ui.msg.textContent = 'Mvu API ä¸å¯ç”¨';
              return;
            }
            render(Mvu.getCurrentMvuData());
            ui.msg.textContent = 'å·²åˆ·æ–°';
          });
          $('#btn-copy').addEventListener('click', async () => {
            try {
              if (!Mvu) throw new Error('Mvu API ä¸å¯ç”¨');
              const data = Mvu.getCurrentMvuData();
              const frag = Mvu.getMvuVariable(data, 'prompt.spatial_gate', { category: 'display' }) || '';
              await navigator.clipboard.writeText(frag);
              ui.msg.textContent = 'å·²å¤åˆ¶æç¤ºç‰‡æ®µ';
            } catch (err) {
              ui.msg.textContent = 'å¤åˆ¶å¤±è´¥ï¼š' + ((err && err.message) || err);
            }
          });
          settingsBtn.addEventListener('click', e => {
            e.stopPropagation();
            const isVisible = settingsDropdown.style.display !== 'none';
            settingsDropdown.style.display = isVisible ? 'none' : 'block';
          });
          document.addEventListener('click', () => {
            settingsDropdown.style.display = 'none';
          });
          $('#dropdown-fullscreen').addEventListener('click', async () => {
            settingsDropdown.style.display = 'none';
            try {
              if (document.fullscreenElement) {
                await document.exitFullscreen();
              } else {
                await fsEl.requestFullscreen();
              }
            } catch (e) {}
          });
          $('#dropdown-image-manager').addEventListener('click', () => {
            settingsDropdown.style.display = 'none';
            showImageManager();
          });
          document.addEventListener(
            'fullscreenchange',
            () => {
              const fullscreenItem = $('#dropdown-fullscreen');
              if (document.fullscreenElement) {
                fullscreenItem.textContent = 'â¤¡ é€€å‡ºå…¨å±';
              } else {
                fullscreenItem.textContent = 'â¤¢ å…¨å±';
              }
            },
            { passive: true },
          );
          $('#close-image-manager').addEventListener('click', hideImageManager);
          $('#image-manager-modal').addEventListener('click', e => {
            if (e.target.id === 'image-manager-modal') {
              hideImageManager();
            }
          });
          $$('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const tabName = btn.getAttribute('data-tab');
              $$('.tab-btn').forEach(b => b.classList.remove('active'));
              $$('.tab-content').forEach(c => (c.style.display = 'none'));
              btn.classList.add('active');
              $(`#tab-${tabName}`).style.display = 'flex';
            });
          });
          $('#add-image-url').addEventListener('click', addImageFromUrl);
          $('#image-url-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
              addImageFromUrl();
            }
          });
          $('#add-image-file').addEventListener('click', () => {
            $('#image-file-input').click();
          });
          $('#image-file-input').addEventListener('change', addImageFromFile);
          $('#prev-image').addEventListener('click', () => {
            if (savedImages.length === 0) {
              ui.msg.textContent = 'æ²¡æœ‰å¯åˆ‡æ¢çš„å›¾ç‰‡';
              return;
            }
            const newIndex = selectedImageIndex > 0 ? selectedImageIndex - 1 : savedImages.length - 1;
            selectImageManually(newIndex);
          });
          $('#next-image').addEventListener('click', () => {
            if (savedImages.length === 0) {
              ui.msg.textContent = 'æ²¡æœ‰å¯åˆ‡æ¢çš„å›¾ç‰‡';
              return;
            }
            const newIndex = selectedImageIndex < savedImages.length - 1 ? selectedImageIndex + 1 : 0;
            selectImageManually(newIndex);
          });
          $('#random-image').addEventListener('click', () => {
            if (savedImages.length === 0) {
              ui.msg.textContent = 'æ²¡æœ‰å¯åˆ‡æ¢çš„å›¾ç‰‡';
              return;
            }
            if (savedImages.length === 1) {
              selectImageManually(0);
              return;
            }
            let newIndex;
            do {
              newIndex = Math.floor(Math.random() * savedImages.length);
            } while (newIndex === selectedImageIndex);
            selectImageManually(newIndex);
          });
          $('#portal-placeholder').addEventListener('click', () => {
            showImageManager();
          });
          $('#save-image-edit').addEventListener('click', saveImageEdit);
          $('#cancel-image-edit').addEventListener('click', cancelImageEdit);
          $('#close-edit-modal').addEventListener('click', cancelImageEdit);
          $('#image-edit-modal').addEventListener('click', e => {
            if (e.target.id === 'image-edit-modal') {
              cancelImageEdit();
            }
          });
          $('#slideshow-enabled').addEventListener('change', saveSlideshowSettings);
          $('#slideshow-interval').addEventListener('change', saveSlideshowSettings);
        }
        // è‡ªåŠ¨ç›‘å¬æ¥¼å±‚ä¸­çš„<Door>æ ‡ç­¾
        function startDoorTagMonitoring() {
          // æŸ¥æ‰¾åŒ…å«ç©ºé—´é—¨çš„æ¥¼å±‚å®¹å™¨
          let floorContainer = null;
          let currentElement = document.querySelector('[data-door-ui]');

          // å‘ä¸ŠæŸ¥æ‰¾æ¥¼å±‚å®¹å™¨ï¼ˆæ ¹æ®é…’é¦†çš„DOMç»“æ„è°ƒæ•´ï¼‰
          while (currentElement && currentElement.parentElement) {
            currentElement = currentElement.parentElement;
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥¼å±‚å®¹å™¨ï¼ˆé…’é¦†å¸¸è§çš„å®¹å™¨ç±»åå’ŒIDï¼‰
            if (currentElement.classList.contains('floor') ||
                currentElement.classList.contains('room') ||
                currentElement.classList.contains('chat-message') ||
                currentElement.classList.contains('mes') ||
                currentElement.classList.contains('group-member') ||
                currentElement.classList.contains('swipe') ||
                currentElement.id && (
                  currentElement.id.includes('floor') ||
                  currentElement.id.includes('room') ||
                  currentElement.id.includes('mes') ||
                  currentElement.id.includes('chat')
                )) {
              floorContainer = currentElement;
              break;
            }
          }

          // å¦‚æœæ²¡æ‰¾åˆ°ç‰¹å®šå®¹å™¨ï¼ŒæŸ¥æ‰¾æœ€è¿‘çš„åŒ…å«å¤§é‡æ–‡æœ¬çš„å®¹å™¨
          if (!floorContainer) {
            let element = document.querySelector('[data-door-ui]');
            while (element && element.parentElement) {
              element = element.parentElement;
              const textLength = (element.innerText || '').length;
              // å¦‚æœå®¹å™¨åŒ…å«è¾ƒå¤šæ–‡æœ¬å†…å®¹ï¼ˆå¯èƒ½æ˜¯å¯¹è¯æˆ–æ¥¼å±‚å†…å®¹ï¼‰
              if (textLength > 100) {
                floorContainer = element;
                break;
              }
            }
          }

          // æœ€åé€€å›åˆ°body
          if (!floorContainer) {
            floorContainer = document.body;
          }

          let lastProcessedText = '';
          let lastDoorKeywords = [];

          function checkForDoorTags() {
            if (!floorContainer) return;

            // è·å–æ¥¼å±‚ä¸­çš„æ‰€æœ‰HTMLå†…å®¹ï¼ŒåŒ…æ‹¬å¯èƒ½è¢«éšè—çš„æ ‡ç­¾
            let floorHTML = floorContainer.innerHTML || '';

            // ä¹Ÿæ£€æŸ¥çº¯æ–‡æœ¬å†…å®¹
            const floorText = floorContainer.innerText || floorContainer.textContent || '';

            // åˆå¹¶æ£€æŸ¥HTMLå’Œæ–‡æœ¬å†…å®¹
            const combinedContent = floorHTML + '\n' + floorText;

            // å¦‚æœå†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡å¤„ç†
            if (combinedContent === lastProcessedText) return;
            lastProcessedText = combinedContent;

            // æå–Dooræ ‡ç­¾ä¸­çš„å…³é”®è¯
            const doorKeywords = extractDoorKeywords(combinedContent);

            // å¦‚æœå…³é”®è¯æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡å¤„ç†
            if (doorKeywords.length === lastDoorKeywords.length &&
                doorKeywords.every((keyword, index) => keyword === lastDoorKeywords[index])) {
              return;
            }

            lastDoorKeywords = doorKeywords;

            // å¦‚æœæ‰¾åˆ°Dooræ ‡ç­¾å…³é”®è¯ï¼Œè¿›è¡ŒåŒ¹é…
            if (doorKeywords.length > 0) {
              const success = autoSelectImageByDoorKeywords(combinedContent);
              if (success) {
                console.log('ç©ºé—´é—¨ï¼šæ£€æµ‹åˆ°Dooræ ‡ç­¾', doorKeywords, 'å¹¶è‡ªåŠ¨åŒ¹é…å›¾ç‰‡');
              } else {
                console.log('ç©ºé—´é—¨ï¼šæ£€æµ‹åˆ°Dooræ ‡ç­¾', doorKeywords, 'ä½†æœªæ‰¾åˆ°åŒ¹é…å›¾ç‰‡');
              }
            }
          }

          // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–
          if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver((mutations) => {
              let shouldCheck = false;
              mutations.forEach((mutation) => {
                if (mutation.type === 'childList' ||
                    mutation.type === 'characterData' ||
                    mutation.type === 'attributes') {
                  shouldCheck = true;
                }
              });
              if (shouldCheck) {
                // å»¶è¿Ÿæ£€æŸ¥ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„å¤„ç†
                setTimeout(checkForDoorTags, 200);
              }
            });

            observer.observe(floorContainer, {
              childList: true,
              subtree: true,
              characterData: true,
              attributes: true
            });

            const containerInfo = floorContainer === document.body ? 'document.body' :
                                 (floorContainer.className || floorContainer.tagName || 'æœªçŸ¥å®¹å™¨');
            ui.msg.textContent = `ç©ºé—´é—¨ç›‘å¬ä¸­... (${containerInfo})`;
            console.log('ç©ºé—´é—¨ï¼šå·²å¼€å§‹ç›‘å¬æ¥¼å±‚ä¸­çš„Dooræ ‡ç­¾ï¼Œç›‘å¬å®¹å™¨ï¼š', floorContainer);
          } else {
            ui.msg.textContent = 'ç©ºé—´é—¨ç›‘å¬å¯åŠ¨å¤±è´¥';
          }

          // åˆå§‹æ£€æŸ¥ä¸€æ¬¡
          setTimeout(checkForDoorTags, 1000);
        }

        function init() {
          bind(); // å§‹ç»ˆç»‘å®šäº‹ä»¶ç›‘å¬å™¨
          if (!Mvu) {
            ui.msg.textContent = 'æœªæ£€æµ‹åˆ° Mvu API';
            return;
          }
          render(Mvu.getCurrentMvuData());

          // å¯åŠ¨Dooræ ‡ç­¾ç›‘å¬
          setTimeout(startDoorTagMonitoring, 1000);
        }

        // æš´éœ²ç»™å¤–éƒ¨è°ƒç”¨çš„API
        if (typeof window !== 'undefined') {
          window.DoorImageProcessor = {
            processAIResponse: processAIResponse,
            extractDoorKeywords: extractDoorKeywords,
            matchImagesByDoorKeywords: matchImagesByDoorKeywords,
            startSlideshow: startSlideshow,
            stopSlideshow: stopSlideshow,
          };
        }

        init();
      })();
    </script>
  </body>
</html>
