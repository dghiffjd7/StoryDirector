<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MiPhone Door</title>
  </head>
  <body>
    <div id="MiPhone-door-root" style="display: none">MiPhone</div>
    <div data-door-ui></div>
    <script>
      (function () {
        const mount = document.querySelector('[data-door-ui]');
        if (!mount) return;
        const root = mount.attachShadow({ mode: 'open' });
        root.innerHTML =
          '<style>@import url("https://dghiffjd7.github.io/StoryDirector/door/door.css");</style><div class="fs"><div class="phone-wrap"><div class="phone"><div class="notch"></div><div class="screen"><div class="portal" aria-hidden="true"><div class="ring r1"></div><div class="ring r2"></div><div class="ring r3"></div></div><div class="hud"><div class="topbar"><div class="title">空间门 · 控制面板</div><div class="spacer"></div><button id="btn-full" class="icon-btn" title="全屏">⤢</button><div class="pts" id="ui-pts">剩余点数：--</div></div><div class="cards"><div class="card" id="card-attrs"><div class="row"><div class="k">距离(m)</div><div class="val" id="v-range">--</div><div class="btns"><button data-k="range_m" data-d="+1">+1</button><button data-k="range_m" data-d="-1">-1</button></div></div><div class="row"><div class="k">开口(cm)</div><div class="val" id="v-aperture">--</div><div class="btns"><button data-k="aperture_cm" data-d="+2">+2</button><button data-k="aperture_cm" data-d="-2">-2</button></div></div><div class="row"><div class="k">持续(s)</div><div class="val" id="v-duration">--</div><div class="btns"><button data-k="duration_s" data-d="+1">+1</button><button data-k="duration_s" data-d="-1">-1</button></div></div><div class="row"><div class="k">冷却(s)</div><div class="val" id="v-cd">--</div><div class="btns"><button data-k="cooldown_s" data-d="-2">-2</button><button data-k="cooldown_s" data-d="+2">+2</button></div></div><div class="row"><div class="k">稳定等级</div><div class="val" id="v-stab">--</div><div class="btns"><button data-k="stability" data-d="+1">+1</button><button data-k="stability" data-d="-1">-1</button></div></div></div></div><div class="foot"><div class="bar"><button id="btn-copy" class="ghost">复制提示片段</button><button id="btn-refresh" class="ghost">刷新数值</button></div><div class="frag" id="frag">提示片段将显示在此处…</div><div class="warn" id="msg"></div></div></div></div></div></div>';
        const $ = sel => root.querySelector(sel);
        const $$ = sel => Array.from(root.querySelectorAll(sel));
        const Mvu = typeof parent !== 'undefined' && parent && parent.Mvu ? parent.Mvu : null;
        const ui = {
          pts: $('#ui-pts'),
          msg: $('#msg'),
          frag: $('#frag'),
          vals: {
            range: $('#v-range'),
            aperture: $('#v-aperture'),
            duration: $('#v-duration'),
            cd: $('#v-cd'),
            stab: $('#v-stab'),
          },
        };
        const fsEl = root.querySelector('.fs');
        const fullBtn = $('#btn-full');
        const n = x => (typeof x === 'number' ? x : Number(x) || 0);
        function boundsOf(key) {
          const map = {
            range_m: { min: 1, max: 100, step: 1 },
            aperture_cm: { min: 5, max: 200, step: 2 },
            duration_s: { min: 1, max: 120, step: 1 },
            cooldown_s: { min: 0, max: 300, step: 2 },
            stability: { min: 1, max: 10, step: 1 },
          };
          return map[key] || { min: -1e9, max: 1e9, step: 1 };
        }
        function render(data) {
          const get = (p, cat = 'stat') => Mvu.getMvuVariable(data, p, { category: cat });
          ui.pts.textContent = `剩余点数：${n(get('points.remaining'))}`;
          ui.vals.range.textContent = n(get('ability.spatial_gate.range_m'));
          ui.vals.aperture.textContent = n(get('ability.spatial_gate.aperture_cm'));
          ui.vals.duration.textContent = n(get('ability.spatial_gate.duration_s'));
          ui.vals.cd.textContent = n(get('ability.spatial_gate.cooldown_s'));
          ui.vals.stab.textContent = n(get('ability.spatial_gate.stability'));
          const frag = get('prompt.spatial_gate', 'display') || '';
          ui.frag.textContent = frag || '（尚未生成提示片段）';
        }
        async function updatePromptFragment(data) {
          const get = p => Mvu.getMvuVariable(data, p);
          const r = n(get('ability.spatial_gate.range_m'));
          const a = n(get('ability.spatial_gate.aperture_cm'));
          const d = n(get('ability.spatial_gate.duration_s'));
          const c = n(get('ability.spatial_gate.cooldown_s'));
          const s = n(get('ability.spatial_gate.stability'));
          const frag = `空间门 | 距离≤${r}m，开口≤${a}cm，持续≤${d}s，冷却≥${c}s，稳定Lv${s}`;
          await Mvu.setMvuVariable(data, 'prompt.spatial_gate', frag, {
            reason: '刷新能力提示片段',
            is_recursive: true,
          });
        }
        async function applyDelta(key, delta) {
          ui.msg.textContent = '';
          if (!Mvu) {
            ui.msg.textContent = 'Mvu API 不可用';
            return;
          }
          const data = Mvu.getCurrentMvuData();
          const left = n(Mvu.getMvuVariable(data, 'points.remaining'));
          const cur = n(Mvu.getMvuVariable(data, `ability.spatial_gate.${key}`));
          const b = boundsOf(key);
          let cost = 0;
          if (key === 'cooldown_s') cost = delta < 0 ? 1 : 0;
          else cost = delta > 0 ? 1 : 0;
          if (cost > 0 && left <= 0) {
            ui.msg.textContent = '点数不足';
            return;
          }
          let nxt = Math.max(b.min, Math.min(b.max, cur + delta));
          if (nxt === cur) {
            ui.msg.textContent = '已到达边界';
            return;
          }
          await Mvu.setMvuVariable(data, `ability.spatial_gate.${key}`, nxt, {
            reason: `调参 ${key}: ${cur}->${nxt}`,
            is_recursive: true,
          });
          if (cost !== 0) {
            await Mvu.setMvuVariable(data, 'points.remaining', Math.max(0, left - cost), {
              reason: cost > 0 ? '消耗点数' : '返还点数',
              is_recursive: true,
            });
          }
          await updatePromptFragment(data);
          await Mvu.replaceCurrentMvuData(data);
          render(data);
          ui.msg.textContent = `已更新 ${key}: ${cur} → ${nxt}`;
        }
        function bind() {
          $$('#card-attrs button[data-k]').forEach(btn => {
            btn.addEventListener('click', () => {
              const key = btn.getAttribute('data-k');
              const delta = Number(btn.getAttribute('data-d')) || 0;
              applyDelta(key, delta);
            });
          });
          $('#btn-refresh').addEventListener('click', () => {
            if (!Mvu) {
              ui.msg.textContent = 'Mvu API 不可用';
              return;
            }
            render(Mvu.getCurrentMvuData());
            ui.msg.textContent = '已刷新';
          });
          $('#btn-copy').addEventListener('click', async () => {
            try {
              if (!Mvu) throw new Error('Mvu API 不可用');
              const data = Mvu.getCurrentMvuData();
              const frag = Mvu.getMvuVariable(data, 'prompt.spatial_gate', { category: 'display' }) || '';
              await navigator.clipboard.writeText(frag);
              ui.msg.textContent = '已复制提示片段';
            } catch (err) {
              ui.msg.textContent = '复制失败：' + ((err && err.message) || err);
            }
          });
          fullBtn.addEventListener('click', async () => {
            try {
              if (document.fullscreenElement === fsEl) {
                await document.exitFullscreen();
              } else {
                await fsEl.requestFullscreen();
              }
            } catch (e) {}
          });
          document.addEventListener(
            'fullscreenchange',
            () => {
              if (document.fullscreenElement === fsEl) {
                fullBtn.textContent = '⤡';
                fullBtn.title = '退出全屏';
              } else {
                fullBtn.textContent = '⤢';
                fullBtn.title = '全屏';
              }
            },
            { passive: true },
          );
        }
        function init() {
          if (!Mvu) {
            ui.msg.textContent = '未检测到 Mvu API';
            return;
          }
          bind();
          render(Mvu.getCurrentMvuData());
        }
        init();
      })();
    </script>
  </body>
</html>
